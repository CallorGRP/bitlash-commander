<!DOCTYPE html>
<!-- 
	Copyright 2012 by Bill Roy - MIT license - See LICENSE file
-->
<html><head>
<title>Arduino Commander</title>
<script type='text/javascript' src='js/jquery-1.8.2.min.js'></script>
<script type='text/javascript' src='/js/fastclick.js'></script>
<script type='text/javascript' src='/js/raphael.js'></script>
<script type='text/javascript' src='js/kibo.js'></script>
<script type='text/javascript' src='/socket.io/socket.io.js'></script>
</head><body style='background:gray'>

<script type='text/javascript' charset='utf8'>

$(document).ready(function() {

var socket;
var reply_handler;

function initSocketIO() {
	socket = io.connect();
	console.log('Socket connected', socket);
//	window.setTimeout(function() {
//		connection_indicator.attr({fill: '#00ff00', stroke:'#00ff00'});
//	}, 500);
	socket.on('reply', function (data) {
		console.log('Bitlash reply:', data);
		if (reply_handler) {
			var temp_reply_handler = reply_handler;
			reply_handler = undefined;
			temp_reply_handler(data);
		}
	});
	socket.on('pong', function(data) {
		var rtt = new Date().getTime() - data.timestamp;
		window.status = 'RTT: ' + rtt + 'ms';
	});
	socket.on('disconnect', function (data) {
		//connection_indicator.attr({stroke: 'darkgreen', fill: 'darkgreen'});		
		window.setTimeout(initSocketIO, 200);
	});
	window.setInterval(function() {
		socket.emit('ping', {'timestamp': new Date().getTime()});
	}, 10000);
}
initSocketIO();


var face_width = 1 * $(window).width();
var face_height = 1 * $(window).height();
var face_topleft_x = ($(window).width() - face_width)/2;
var face_topleft_y = ($(window).height() - face_height)/2;

var face_color = 'mediumseagreen';
var face_fill = 'black';
var face_stroke = face_color;

var paper = Raphael(0, 0, $(window).width(), $(window).height());

var face = paper.rect(face_topleft_x, face_topleft_y, face_width, face_height, 20)
	.attr({stroke: face_stroke, fill: face_fill, 'stroke-width': 10});

var button_corner = 10;
var controls = {};

//////////
//
//	Button control
//
function Button(options) {
	return this.init(options || {});
}

Button.prototype = {

	init: function(options) {
		this.id = options.id || 'Unnamed' + Math.floor(Math.random()*10000),
		this.x = face_topleft_x + (options.x || 50);
		this.y = face_topleft_y + (options.y || 50);
		this.w = options.w || 50;
		this.h = options.h || 50;
		this.text = options.text || 'Untitled';
		this.script = options.script || '';
		this.fill = options.fill || 'black';
		this.fill_highlight = options.fill_highlight || 'white';
		this.stroke = options.stroke || face_color;
		this['stroke-width'] = options['stroke-width'] || 5;
		this.fontsize = options.fontsize || 20;

		var self = this;
		this.elt = paper.rect(this.x, this.y, this.w, this.h, button_corner)
			.attr({fill:this.fill, stroke:this.stroke, 'stroke-width': this['stroke-width']})
			.click(function(e) {
				e.preventDefault();
				e.stopPropagation();
				socket.emit('exec', {'cmd': self.script});
				reply_handler = function(reply) { self.handleReply.call(self, reply); };
				return true;
			});

		this.label = paper.text(this.x + (this.w/2), this.y + (this.h/2), this.text)
			.attr({fill:this.stroke, stroke:this.stroke, 'font-size': this.fontsize});

		return this;
	},

	handleReply: function(reply) {
		console.log('Handle:', reply, typeof reply, this);
		var color = (parseInt(reply) != 0) ? this.fill_highlight : this.fill;
		this.elt.attr({fill:color});
	}
}

function addButton(options) {
	var button = new Button(options);
	controls[button.id] = button;
}

addButton({x:100,y:100,w:150,h:60,text:'Toggle',script:'d13=!d13;print d13'});


//////////
//
//	Slider control
//
function Slider(options) {
	return this.init(options || {});
}

Slider.prototype = {

	init: function(options) {
		this.id = options.id || 'Unnamed' + Math.floor(Math.random()*10000),
		this.x = face_topleft_x + (options.x || 50);
		this.y = face_topleft_y + (options.y || 50);
		this.w = options.w || 50;
		this.h = options.h || 200;
		this.text = options.text || 'Untitled';
		this.script = options.script || '';
		this.fill = options.fill || 'black';
		this.fill_highlight = options.fill_highlight || 'white';
		this.stroke = options.stroke || face_color;
		this['stroke-width'] = options['stroke-width'] || 5;
		this.fontsize = options.fontsize || 20;

		this.min = options.min || 0;
		this.max = options.max || 255;
		this.value = options.value || this.min;

		this.slidew = this.w;
		this.slideh = options.slideh || 1+Math.floor(this.h / 16);

		this.barw = options.barw || 1+Math.floor(this.w / 16);
		this.barh = this.h;

		var self = this;

		this.outerrect = paper.rect(this.x, this.y, this.w, this.h)
			.attr({fill:'red', stroke:'red'});

		this.elt = paper.rect(this.x + (this.w-this.barw)/2, this.y, this.barw, this.barh)
			.attr({fill:this.stroke, stroke:this.stroke, 'stroke-width': this['stroke-width']})
			.click(function(e) {
				console.log('bar click:', e);
			});

		this.slide = paper.rect(this.x, this.y, this.slidew, this.slideh, 5)
			.attr({fill:this.stroke, stroke:this.stroke, 'stroke-width': this['stroke-width']})
			.drag(this.dragMove, this.dragStart, this.dragEnd, this, this, this);


		this.label = paper.text(this.x + (this.w/2), this.y + this.h + this.fontsize*2, this.text)
			.attr({fill:this.stroke, stroke:this.stroke, 'font-size': this.fontsize});

		return this;
	},

	dragStart: function(x, y, event) {
		//this.dragy = y;
	},
	dragMove: function(dx, dy, x, y, event) {
		console.log('move:',dx,dy,x,y,event)
		if (y < this.y) y = this.y;
		else if (y > this.y + this.h) y = this.y + this.h;
		var fraction = (y - this.y) / this.h;
		this.value = this.min + (1.0 - fraction) * (this.max - this.min);
		var slidey = this.slideYPos();
console.log('frac:', fraction, this.value, slidey);
		this.slide.attr({y:slidey});
	},
	dragEnd: function(e) {
		e.preventDefault();
		e.stopPropagation();
		socket.emit('exec', {'cmd': self.script});
		reply_handler = function(reply) { self.handleReply.call(self, reply); };
		return true;
	},

	slideYPos: function() {
		if (this.value < this.min) this.value = this.min;
		if (this.value > this.max) this.value = this.max;
		var fraction = (this.value - this.min) / (this.max - this.min);
		return Math.floor(this.y + this.h * (1.0 - fraction));
	},

	handleReply: function(reply) {
		console.log('Handle:', reply, typeof reply, this);
	}
}

function addSlider(options) {
	var slider = new Slider(options);
	controls[slider.id] = slider;
}

// need to get value from control into script...
// templating for the script
addSlider({x:400,y:100,text:'Fade1',script:'d3=0'});
addSlider({x:600,y:100,text:'Fade2',script:'d3=0'});




}); 	// document.ready
</script>
Click the button...
</body></html>
